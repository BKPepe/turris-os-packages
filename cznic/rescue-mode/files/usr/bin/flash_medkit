#!/bin/sh -e
set -e

echo "Unpack medkit files"
[ -d /tmp/rescue ] && rm -rf /tmp/rescue
mkdir /tmp/rescue
dd if=$1 of=/tmp/rescue/medkit.tar.xz 2>&1 >/dev/null
cd /tmp/rescue
unxz ./medkit.tar.xz
tar xf ./medkit.tar

echo "Erase mtd devices"
i=3
while [ $i != 0 ]; do
	i=$(($i - 1))
	echo -n "$i "
	sleep 1
done
echo

flash_erase -q /dev/mtd7 0 0
flash_erase -q /dev/mtd8 0 0
flash_erase -q /dev/mtd9 0 0

echo "Erased"
echo "Flash new images"

nandwrite -pq /dev/mtd7 openwrt-mpc85xx-p2020-turris-nand-*m.fdt
nandwrite -pq /dev/mtd8 openwrt-mpc85xx-p2020-zImage
nandwrite -pq /dev/mtd9 openwrt-mpc85xx-p2020-jffs2-nand-2048-128k.img

echo Done! 

